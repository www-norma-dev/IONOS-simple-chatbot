# Kubernetes Deployment

This page covers Kubernetes-specific concepts: manifest templating, secrets, obtaining kubeconfig from IONOS Cloud, verifying, rollback, and cleanup.

## Manifest Templating
The file `kubernetes_config.tpl` contains `${BACKEND_IMAGE}` and `${FRONTEND_IMAGE}` placeholders. During CI the workflow exports these env vars and runs:
```bash
envsubst < kubernetes_config.tpl > kubernetes_config.yaml
```
So the resulting applied file references the exact immutable image tags from the release tag.

### Snippet
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  template:
    spec:
      containers:
      - name: backend
        image: ${BACKEND_IMAGE}  # substituted in CI
```

## Secrets
Runtime API keys are injected via a recreated generic secret `secrets`:
```bash
kubectl delete secret secrets --ignore-not-found
kubectl create secret generic secrets \
  --from-literal=IONOS_API_KEY=*** \
  --from-literal=TAVILY_API_KEY=***
```
Deployments reference them with `valueFrom.secretKeyRef`.

## Obtaining kubeconfig from IONOS Cloud
You need the kubeconfig file to let both local `kubectl` and CI access the cluster.

### Console Steps
1. Sign in to the IONOS Cloud Console (dashboard home).
2. In the left sidebar click **Containers**.
3. Click **Managed Kubernetes**.
4. Select your cluster (e.g. `ionos-chatbot-starter-pack`).
5. In the Cluster Settings view click the download button next to **kubeconfig.yaml**.
6. Save the file securely (e.g., `~/kube/cluster-admin.yaml`).
7. (Optional) Review / redact before storing as a secret.

### Screenshots
Step 1:
![Dashboard Home – landing](/assets/kubernetes/dashboard.jpg)
Step 2:
![Containers Menu – select Managed Kubernetes](/assets/kubernetes/containers-menu.jpg)
Step 3:
![Cluster Settings – download kubeconfig.yaml](/assets/kubernetes/download.jpg)

## Add kubeconfig as GitHub Secret
1. Open the file → copy all contents.
2. GitHub: Settings → Secrets and variables → Actions → New repository secret.
3. Name: `KUBE_CONFIG`.
4. Paste → Save.

## Local Validation
Mac/Linux:
```bash
export KUBECONFIG=~/kube/cluster-admin.yaml
kubectl get nodes
kubectl get deployments
```
Windows PowerShell:
```powershell
$env:KUBECONFIG = "$HOME\kube\cluster-admin.yaml"
kubectl get nodes
```

## Verifying Live Deployment
```bash
kubectl get pods
kubectl get svc backend-service
kubectl get svc streamlit-service
```
If `EXTERNAL-IP` is `<pending>`, wait until the LoadBalancer is provisioned.

## Rollouts & Rollback
Check rollout:
```bash
kubectl rollout status deployment/backend
```
Rollback to previous revision:
```bash
kubectl rollout undo deployment/backend --to-revision=1
```
List revisions (if supported by your cluster's controller history limit):
```bash
kubectl rollout history deployment/backend
```

## Scaling
```bash
kubectl scale deployment/backend --replicas=2
```

## Cleanup
```bash
kubectl delete -f kubernetes_config.yaml
kubectl delete secret secrets
```

## Summary
Kubernetes deployment is driven by a templated manifest, immutable versioned images, and recreated secrets. Managing kubeconfig securely and validating rollouts keeps the platform reliable.
